<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Chapter ‚Äì EduPlan AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    body {
      -webkit-tap-highlight-color: transparent;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è Markdown –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
    .prose pre {
      background: #111827;
      color: white;
      padding: 1rem;
      border-radius: 0.75rem;
      overflow-x: auto;
      font-size: 0.875rem;
    }

    .prose img {
      border-radius: 0.75rem;
      margin: 2rem auto;
    }

    /* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä –¥–ª—è —Å–∞–π–¥–±–∞—Ä–∞ */
    .custom-scrollbar::-webkit-scrollbar {
      width: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background-color: #e2e8f0;
      border-radius: 10px;
    }
  </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 h-screen flex flex-col text-gray-900 dark:text-gray-100 overflow-hidden">

  <header class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md border-b border-gray-200 dark:border-gray-700 px-4 md:px-8 py-3 md:py-4 flex items-center justify-between shrink-0 z-50">
    <a href="course-dashboard.html" class="flex items-center text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 font-medium transition-colors">
      <span class="mr-1 text-xl">‚Üê</span> 
      <span class="hidden sm:inline">Dashboard</span>
    </a>
    <h2 id="chapterTitle" class="font-bold text-base md:text-xl truncate px-4 text-center flex-1">Loading Chapter...</h2>
    <div class="w-10 sm:hidden"></div> </header>

  <div class="flex flex-1 overflow-hidden">

    <aside class="hidden lg:flex flex-col w-80 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 overflow-y-auto custom-scrollbar p-6">
      <h3 class="text-xs font-bold uppercase tracking-widest text-gray-400 mb-6">Course Modules</h3>
      <ul id="sidebarList" class="space-y-2">
        </ul>
    </aside>

    <main class="flex-1 overflow-y-auto bg-white dark:bg-gray-900 relative">
      
      <div class="sticky top-0 z-40 bg-white/80 dark:bg-gray-900/80 backdrop-blur-md px-4 py-4 border-b border-gray-100 dark:border-gray-800">
        <div class="max-w-4xl mx-auto">
          <div class="inline-flex w-full sm:w-auto bg-gray-100 dark:bg-gray-800 rounded-2xl p-1 shadow-inner">
            <button id="tabLecture" onclick="switchTab('lecture')"
              class="flex-1 sm:flex-none px-6 py-2.5 rounded-xl text-sm font-bold transition-all duration-200 bg-white dark:bg-gray-700 shadow-sm text-indigo-600 dark:text-indigo-300">
              üìñ Lecture
            </button>
            <button id="tabQuiz" onclick="switchTab('quiz')"
              class="flex-1 sm:flex-none px-6 py-2.5 rounded-xl text-sm font-bold transition-all duration-200 text-gray-500 dark:text-gray-400 hover:text-gray-900">
              üìù Quiz
            </button>
          </div>
        </div>
      </div>

      <div class="max-w-4xl mx-auto p-4 md:p-10 pb-32">

        <div id="lectureView" class="space-y-8 animate-in fade-in duration-500">
          <article id="lectureContent"
            class="prose prose-slate md:prose-lg dark:prose-invert max-w-none prose-headings:font-bold prose-a:text-indigo-600 dark:prose-a:text-indigo-400 prose-strong:text-indigo-600 dark:prose-strong:text-indigo-300">
            </article>

          <div class="pt-10 border-t border-gray-100 dark:border-gray-800">
            <button onclick="switchTab('quiz')"
              class="w-full sm:w-auto bg-indigo-600 text-white px-8 py-4 rounded-2xl font-bold hover:bg-indigo-700 active:scale-[0.98] shadow-xl shadow-indigo-100 dark:shadow-none transition-all flex items-center justify-center gap-2">
              Ready for the Quiz? <span class="text-xl">‚Üí</span>
            </button>
          </div>
        </div>

        <div id="quizView" class="hidden animate-in slide-in-from-bottom-4 duration-500">
          <div class="mb-10">
            <h2 class="text-2xl sm:text-3xl font-black mb-2">Knowledge Check</h2>
            <p class="text-gray-500 dark:text-gray-400">Answer all questions to unlock the next module.</p>
          </div>

          <form id="quizForm" class="space-y-6">
            </form>

          <div id="quizResult" class="hidden mt-10 p-6 md:p-10 rounded-[2rem] border transition-all">
            </div>
        </div>

      </div>
    </main>
  </div>

  <div class="lg:hidden fixed bottom-6 left-1/2 -translate-x-1/2 z-50 w-[90%] max-w-sm">
      <div id="mobileNextBtn" class="hidden bg-indigo-600 text-white p-4 rounded-2xl shadow-2xl flex items-center justify-between animate-bounce">
          <span class="font-bold text-sm">Module complete!</span>
          <button onclick="window.location.href='course-dashboard.html'" class="bg-white text-indigo-600 px-4 py-2 rounded-xl text-xs font-black">Continue ‚Üí</button>
      </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3000';
    const chapterId = localStorage.getItem('currentChapterId');
    const courseId = localStorage.getItem('currentCourseId');

    let currentChapterData = null;
    let nextChapterId = null;

    async function init() {
      if (!chapterId || !courseId) {
        window.location.href = 'course-dashboard.html';
        return;
      }
      await loadSidebar();
      await loadChapterContent();
    }

    async function loadSidebar() {
      try {
        const res = await fetch(`${API_BASE}/api/courses/${courseId}`);
        const course = await res.json();
        const list = document.getElementById('sidebarList');
        if(!list) return;

        list.innerHTML = '';

        const currentIndex = course.chapters.findIndex(c => c._id === chapterId);
        if (currentIndex !== -1 && currentIndex < course.chapters.length - 1) {
          nextChapterId = course.chapters[currentIndex + 1]._id;
        }

        course.chapters.forEach((ch, index) => {
          const isCurrent = ch._id === chapterId;
          const isPreviousCompleted = index === 0 || course.chapters[index - 1].isCompleted;
          const isLocked = !ch.isCompleted && !isPreviousCompleted;

          const li = document.createElement('li');
          let classes = "px-4 py-3 rounded-xl flex items-center justify-between transition-all duration-200 text-sm ";

          if (isCurrent) {
            classes += "bg-indigo-600 text-white font-bold shadow-lg shadow-indigo-100 dark:shadow-none";
          } else if (isLocked) {
            classes += "text-gray-400 dark:text-gray-600 cursor-not-allowed opacity-60";
          } else {
            classes += "hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-300 cursor-pointer";
          }

          li.className = classes;
          if (!isLocked && !isCurrent) {
            li.onclick = () => {
              localStorage.setItem('currentChapterId', ch._id);
              window.location.reload();
            };
          }

          let icon = isLocked ? `<span>üîí</span>` : `<span class="opacity-50 font-mono text-xs mr-3">${index + 1}.</span>`;
          li.innerHTML = `
            <div class="flex items-center truncate">
                ${icon}
                <span class="truncate">${ch.title}</span>
            </div>
            ${ch.isCompleted ? '<span class="ml-2">‚úì</span>' : ''}
          `;
          list.appendChild(li);
        });
      } catch (e) { console.error("Sidebar error", e); }
    }

    async function loadChapterContent() {
      try {
        const response = await fetch(`${API_BASE}/api/courses/chapters/${chapterId}`);
        if (!response.ok) throw new Error("Failed to load");
        currentChapterData = await response.json();

        document.getElementById('chapterTitle').textContent = currentChapterData.title;
        document.getElementById('lectureContent').innerHTML = marked.parse(currentChapterData.content || '');
        buildQuiz(currentChapterData.quiz);

      } catch (error) {
        document.getElementById('lectureContent').innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
      }
    }

    function buildQuiz(quizData) {
      const form = document.getElementById('quizForm');
      form.innerHTML = '';

      if (!quizData || !quizData.length) {
        form.innerHTML = '<p class="text-gray-500">No quiz available for this chapter.</p>';
        return;
      }

      quizData.forEach((item, i) => {
        const div = document.createElement('div');
        div.className = "bg-gray-50 dark:bg-gray-800/50 p-5 md:p-8 rounded-3xl border border-gray-100 dark:border-gray-800 shadow-sm";
        const options = item.options.map((opt, j) => `
                <label class="flex items-center p-4 mt-3 bg-white dark:bg-gray-900 border border-gray-100 dark:border-gray-800 rounded-2xl cursor-pointer hover:border-indigo-400 hover:shadow-md transition-all active:scale-[0.99]">
                    <input type="radio" name="q${i}" value="${j}" required class="w-5 h-5 text-indigo-600 focus:ring-indigo-500">
                    <span class="ml-4 text-sm md:text-base text-gray-700 dark:text-gray-300">${opt}</span>
                </label>`).join('');

        div.innerHTML = `<p class="font-bold text-base md:text-lg mb-4 text-gray-800 dark:text-gray-100"><span class="text-indigo-500 mr-2">Q${i+1}.</span> ${item.question}</p>${options}`;
        form.appendChild(div);
      });

      const btn = document.createElement('button');
      btn.type = 'submit';
      btn.textContent = "Submit Answers";
      btn.className = "w-full bg-indigo-600 text-white py-4 rounded-2xl font-black mt-8 hover:bg-indigo-700 shadow-xl shadow-indigo-100 dark:shadow-none transition-all active:scale-[0.98]";
      form.appendChild(btn);
    }

    document.getElementById('quizForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      let score = 0;

      currentChapterData.quiz.forEach((item, i) => {
        if (parseInt(formData.get(`q${i}`)) === item.correctAnswer) score++;
      });

      const total = currentChapterData.quiz.length;
      const passed = (score / total) >= 0.6; 

      const resultDiv = document.getElementById('quizResult');
      resultDiv.classList.remove('hidden');

      if (passed) {
        await markChapterAsDone(); 
        resultDiv.className = "mt-10 p-8 rounded-[2rem] bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-100 dark:border-emerald-800 text-emerald-900 dark:text-emerald-100 animate-in zoom-in duration-300";
        
        let nextBtnHtml = nextChapterId 
          ? `<button onclick="goToNextChapter()" class="w-full sm:w-auto bg-emerald-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-emerald-700 shadow-lg mt-6 transition-all active:scale-95">Next Chapter ‚Üí</button>`
          : `<button onclick="window.location.href='course-dashboard.html'" class="w-full sm:w-auto bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold mt-6 shadow-lg">Finish Course üéâ</button>`;

        resultDiv.innerHTML = `
                <div class="flex items-center gap-4 mb-4">
                    <span class="text-4xl">üéâ</span>
                    <div>
                        <h3 class="text-2xl font-black">Passed! (${score}/${total})</h3>
                        <p class="opacity-80">Excellent work. You've mastered this module.</p>
                    </div>
                </div>
                ${nextBtnHtml}
            `;
        loadSidebar();
        if(window.innerWidth < 1024) document.getElementById('mobileNextBtn').classList.remove('hidden');

      } else {
        resultDiv.className = "mt-10 p-8 rounded-[2rem] bg-red-50 dark:bg-red-900/20 border border-red-100 dark:border-red-800 text-red-900 dark:text-red-100 animate-in shake duration-500";
        resultDiv.innerHTML = `
                <h3 class="text-xl font-black mb-2">Not quite there yet...</h3>
                <p class="opacity-80 mb-4">You got ${score} out of ${total}. You need 60% to pass. Don't worry, you can review the lecture and try again!</p>
                <button onclick="switchTab('lecture')" class="text-indigo-600 dark:text-indigo-400 font-bold underline">Review Module Content</button>
            `;
      }

      resultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
    });

    async function markChapterAsDone() {
      await fetch(`${API_BASE}/api/courses/chapters/${chapterId}/complete`, { method: 'POST' });
    }

    function goToNextChapter() {
      if (nextChapterId) {
        localStorage.setItem('currentChapterId', nextChapterId);
        window.location.reload();
      }
    }

    function switchTab(tab) {
      const lectureView = document.getElementById('lectureView');
      const quizView = document.getElementById('quizView');
      const tabL = document.getElementById('tabLecture');
      const tabQ = document.getElementById('tabQuiz');

      if (tab === 'lecture') {
        lectureView.classList.remove('hidden');
        quizView.classList.add('hidden');
        tabL.className = "flex-1 sm:flex-none px-6 py-2.5 rounded-xl text-sm font-bold transition-all duration-200 bg-white dark:bg-gray-700 shadow-sm text-indigo-600 dark:text-indigo-300";
        tabQ.className = "flex-1 sm:flex-none px-6 py-2.5 rounded-xl text-sm font-bold transition-all duration-200 text-gray-500 dark:text-gray-400 hover:text-gray-900";
      } else {
        lectureView.classList.add('hidden');
        quizView.classList.remove('hidden');
        tabQ.className = "flex-1 sm:flex-none px-6 py-2.5 rounded-xl text-sm font-bold transition-all duration-200 bg-white dark:bg-gray-700 shadow-sm text-indigo-600 dark:text-indigo-300";
        tabL.className = "flex-1 sm:flex-none px-6 py-2.5 rounded-xl text-sm font-bold transition-all duration-200 text-gray-500 dark:text-gray-400 hover:text-gray-900";
      }
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    init();
  </script>
</body>

</html>