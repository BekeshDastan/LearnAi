<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chapter ‚Äì EduPlan AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    .prose :where(h1, h2, h3) {
      color: theme('colors.gray.900');
    }

    .dark .prose :where(h1, h2, h3) {
      color: theme('colors.gray.100');
    }

    .prose pre {
      background: #111827;
      color: white;
    }

    .dark .prose pre {
      background: #1f2937;
    }
  </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 h-screen flex flex-col text-gray-900 dark:text-gray-100">

  <header
    class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-4 sm:px-8 py-4 flex items-center justify-between shrink-0">
    <a href="course-dashboard.html"
      class="text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 font-medium">
      ‚Üê Dashboard
    </a>
    <h2 id="chapterTitle" class="font-bold text-lg sm:text-xl truncate max-w-[60vw]">Chapter Title</h2>
    <div class="w-10"></div>
  </header>

  <div class="flex flex-1 overflow-hidden">

    <aside
      class="hidden lg:block w-72 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 overflow-y-auto p-6">
      <h3 class="text-xs font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400 mb-4">Course Modules
      </h3>
      <ul class="space-y-1.5">
        <li
          class="px-4 py-2.5 rounded-lg bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 font-medium cursor-pointer">
          1. Introduction to AsyncIO</li>
        <li
          class="px-4 py-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-300 cursor-pointer">
          2. Coroutines</li>

      </ul>
    </aside>

    <main class="flex-1 overflow-y-auto bg-white dark:bg-gray-900">

      <div class="max-w-4xl mx-auto p-6 lg:p-10 pb-24">

        <div class="inline-flex bg-gray-100 dark:bg-gray-800 rounded-xl p-1 mb-8">
          <button id="tabLecture" onclick="switchTab('lecture')"
            class="px-6 py-2.5 rounded-lg text-sm font-semibold bg-white dark:bg-gray-900 shadow-sm text-indigo-600 dark:text-indigo-400">
            üìñ Lecture
          </button>
          <button id="tabQuiz" onclick="switchTab('quiz')"
            class="px-6 py-2.5 rounded-lg text-sm font-semibold text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200">
            üìù Quiz
          </button>
        </div>

        <div id="lectureView">
          <article id="lectureContent"
            class="prose prose-indigo dark:prose-invert max-w-none prose-headings:font-bold prose-a:text-indigo-600 dark:prose-a:text-indigo-400">
            <!-- Filled by JS -->
          </article>

          <div class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
            <button onclick="switchTab('quiz')"
              class="w-full sm:w-auto bg-indigo-600 text-white px-8 py-4 rounded-xl font-bold hover:bg-indigo-700 shadow-lg transition-all">
              I've finished reading ‚Üí Take Quiz
            </button>
          </div>
        </div>

        <div id="quizView" class="hidden">
          <h2 class="text-2xl sm:text-3xl font-bold mb-8">Quick Knowledge Check</h2>

          <form id="quizForm" class="space-y-8">
            <!-- Filled by JS -->
          </form>

          <div id="quizResult"
            class="hidden mt-10 p-8 bg-emerald-50 dark:bg-emerald-950/40 border border-emerald-200 dark:border-emerald-800/50 rounded-2xl text-emerald-800 dark:text-emerald-200">
            <div class="flex items-center gap-3 mb-4">
              <span class="text-3xl">üéâ</span>
              <h4 class="text-xl font-bold">Great job! You passed.</h4>
            </div>
            <p class="mb-6">Next module is now unlocked.</p>
            <button onclick="window.location.href='course-dashboard.html'"
              class="bg-emerald-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-emerald-700 transition-colors">
              Continue to Next Module ‚Üí
            </button>
          </div>
        </div>

      </div>
    </main>
  </div>

  <script>
    const API_BASE = 'http://localhost:3000';
    const chapterId = localStorage.getItem('currentChapterId');
    const courseId = localStorage.getItem('currentCourseId');

    let currentChapterData = null;
    let nextChapterId = null; 

    async function init() {
      if (!chapterId || !courseId) {
        window.location.href = 'course-dashboard.html';
        return;
      }
      await loadSidebar(); 
      await loadChapterContent();
    }

    async function loadSidebar() {
      try {
        const res = await fetch(`${API_BASE}/api/courses/${courseId}`);
        const course = await res.json();
        const list = document.querySelector('aside ul');
        list.innerHTML = '';

        const currentIndex = course.chapters.findIndex(c => c._id === chapterId);
        if (currentIndex !== -1 && currentIndex < course.chapters.length - 1) {
          nextChapterId = course.chapters[currentIndex + 1]._id;
        }

        course.chapters.forEach((ch, index) => {
          const isCurrent = ch._id === chapterId;
          const isPreviousCompleted = index === 0 || course.chapters[index - 1].isCompleted;
          const isLocked = !ch.isCompleted && !isPreviousCompleted;

          const li = document.createElement('li');

          let classes = "px-4 py-2.5 rounded-lg flex items-center justify-between transition-colors ";

          if (isCurrent) {
            classes += "bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 font-bold border-l-4 border-indigo-500";
          } else if (isLocked) {
            classes += "bg-gray-100 dark:bg-gray-800 text-gray-400 cursor-not-allowed"; 
          } else {
            classes += "hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-300 cursor-pointer";
          }

          li.className = classes;

          if (!isLocked && !isCurrent) {
            li.onclick = () => {
              localStorage.setItem('currentChapterId', ch._id);
              window.location.reload();
            };
          }

          let icon = `<span class="text-sm font-mono mr-3">${index + 1}.</span>`;
          if (isLocked) icon = `<span class="mr-3">üîí</span>`;

          li.innerHTML = `
                    <div class="truncate">
                        ${icon}
                        ${ch.title}
                    </div>
                    ${ch.isCompleted ? '<span class="text-green-500 text-lg">‚úì</span>' : ''}
                `;
          list.appendChild(li);
        });
      } catch (e) { console.error("Sidebar error", e); }
    }

    async function loadChapterContent() {
      try {
        const response = await fetch(`${API_BASE}/api/courses/chapters/${chapterId}`);
        if (!response.ok) throw new Error("Failed to load");
        currentChapterData = await response.json();

        document.getElementById('chapterTitle').textContent = currentChapterData.title;
        document.getElementById('lectureContent').innerHTML = marked.parse(currentChapterData.content || '');
        buildQuiz(currentChapterData.quiz);

      } catch (error) {
        document.getElementById('lectureContent').innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
      }
    }

    function buildQuiz(quizData) {
      const form = document.getElementById('quizForm');
      form.innerHTML = '';

      if (!quizData || !quizData.length) {
        form.innerHTML = '<p>No quiz available.</p>';
        return;
      }

      quizData.forEach((item, i) => {
        const div = document.createElement('div');
        div.className = "bg-gray-50 dark:bg-gray-800 p-6 rounded-2xl border border-gray-200 dark:border-gray-700";
        const options = item.options.map((opt, j) => `
                <label class="flex items-center p-3 mt-2 bg-white dark:bg-gray-900 border rounded-lg cursor-pointer hover:border-indigo-400">
                    <input type="radio" name="q${i}" value="${j}" required class="w-4 h-4 text-indigo-600">
                    <span class="ml-3 text-gray-800 dark:text-gray-200">${opt}</span>
                </label>`).join('');

        div.innerHTML = `<p class="font-bold mb-2">${i + 1}. ${item.question}</p>${options}`;
        form.appendChild(div);
      });

      const btn = document.createElement('button');
      btn.type = 'submit';
      btn.textContent = "Check Answers";
      btn.className = "w-full bg-indigo-600 text-white py-3 rounded-xl font-bold mt-6 hover:bg-indigo-700";
      form.appendChild(btn);
    }

    document.getElementById('quizForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      let score = 0;

      currentChapterData.quiz.forEach((item, i) => {
        if (parseInt(formData.get(`q${i}`)) === item.correctAnswer) score++;
      });

      const total = currentChapterData.quiz.length;
      const passed = (score / total) >= 0.6; 

      const resultDiv = document.getElementById('quizResult');
      resultDiv.classList.remove('hidden');

      resultDiv.className = `mt-10 p-8 rounded-2xl border ${passed ? 'bg-emerald-50 border-emerald-200 text-emerald-800' : 'bg-red-50 border-red-200 text-red-800'}`;

      if (passed) {
        await markChapterAsDone(); 

        let nextBtnHtml = '';
        if (nextChapterId) {
          nextBtnHtml = `
                <button onclick="goToNextChapter()" class="bg-emerald-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-emerald-700 shadow-lg mt-4">
                    Next Chapter ‚Üí
                </button>`;
        } else {
          nextBtnHtml = `
                <button onclick="window.location.href='course-dashboard.html'" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold mt-4">
                    Finish Course üéâ
                </button>`;
        }

        resultDiv.innerHTML = `
                <h3 class="text-2xl font-bold">üéâ Passed! (${score}/${total})</h3>
                <p>Great job! Progress saved.</p>
                ${nextBtnHtml}
            `;
        loadSidebar();

      } else {
        resultDiv.innerHTML = `
                <h3 class="text-xl font-bold">üòï Score: ${score}/${total}</h3>
                <p>You need at least 60% to proceed.</p>
                <button onclick="switchTab('lecture')" class="text-indigo-600 font-bold mt-2 underline">Review Lecture</button>
            `;
      }

      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    });

    async function markChapterAsDone() {
      await fetch(`${API_BASE}/api/courses/chapters/${chapterId}/complete`, { method: 'POST' });
    }

    function goToNextChapter() {
      if (nextChapterId) {
        localStorage.setItem('currentChapterId', nextChapterId);
        window.location.reload();
      }
    }

    function switchTab(tab) {
      document.getElementById('lectureView').classList.toggle('hidden', tab !== 'lecture');
      document.getElementById('quizView').classList.toggle('hidden', tab !== 'quiz');

      document.getElementById('tabLecture').classList.toggle('bg-white', tab === 'lecture');
      document.getElementById('tabQuiz').classList.toggle('bg-white', tab === 'quiz');
    }

    init();
  </script>
</body>

</html>